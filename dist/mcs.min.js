"use strict";(function(){var e=function(){var e=function e(r){if(!r||typeof r!=="string"){var t="Error: Object to parse is not a valid string or does not exist.";console.error(t);return t}function n(e){var r=true,t=true,n="";function u(e){this.vars=Object.create(e?e.vars:null);this.parent=e}u.prototype={extend:function e(){return new u(this)},lookup:function e(r){var t=this;while(t){if(Object.prototype.hasOwnProperty.call(t.vars,r))return t;t=t.parent}},get:function e(r){if(r in this.vars)return this.vars[r];o("Undefined variable "+r)},set:function e(r,t){var n=this.lookup(r);if(!n&&this.parent)o("Undefined variable "+r);return(n||this).vars[r]=t},def:function e(r,t){return this.vars[r]=t}};var a=new u;var i={};x(e,a);return i;function o(e){if(r)console.error(e);throw new Error(e)}function f(e,r,t){function n(e){if(typeof e!="number")o("Expected number but got "+e);return e}function u(e){if(n(e)==0)o("Divide by zero");return e}switch(e){case"+":return n(r)+n(t);case"-":return n(r)-n(t);case"*":return n(r)*n(t);case"/":return n(r)/u(t);case"%":return n(r)%u(t);case"&&":return r!==false&&t;case"||":return r!==false?r:t;case"<":return n(r)<n(t);case">":return n(r)>n(t);case"<=":return n(r)<=n(t);case">=":return n(r)>=n(t);case"==":return r===t;case"!=":return r!==t}o("Can't apply operator "+e)}function c(e,r){function t(e){if(e.type=="command")n+=g(r,e)+"\n";else if(e.type=="return"||e.type=="if"){return x(e,r)}else x(e,r)}if(e.type=="prog"){for(var u=0;u<e.prog.length;u++){var a=t(e.prog[u]);if(a)return a}}else{var a=t(e);if(a)return a}}function l(e,r){function t(){var t=r.vars;var n=e.extend();for(var u=0;u<t.length;++u){n.def(t[u],u<arguments.length?arguments[u]:false)}return c(r.body,n)}return e.set(r.name,t)}function s(e,n){t=r;try{r=false;var u=e.get(n.value);r=t;return u}catch(e){r=t;return n.value}}function p(e,r){var t=x(r.cond,e);if(t!==false){var n=c(r.then,e.extend());if(n)return n}return r.else?x(r.else,e.extend()):false}function v(e,r){var t={};var n=0;r.value.forEach(function(r){var u=x(r,e);t[n]=u;n++});return t}function y(e,r){var t=e.get(r.value);if(r.index){var n=x(r.index,e);if(typeof n!="number")o("Array index must be a number");return t[n]}else return t}function d(e,r){if(r.left.type=="ivar")return e.set(r.left.value,x(r.right,e));else if(r.left.type=="var"){return e.def(r.left.value,x(r.right,e))}}function g(e,r){var t="";if(e.parent==null)o("Commands cannot be used in root");for(var n=0;n<r.value.length;n++){if(n!=0)t+=" ";t+=x(r.value[n],e)}return t}function h(e,r){var t="";r.prog.forEach(function(r){if(r.type=="command"){var u=x(r,e);t+=n+u+"\n";n=""}else x(r,e)});return t}function m(e,r){var t=x(r.body,e.extend());i[r.name]=t}function x(e,r){switch(e.type){case"num":case"str":case"bool":return e.value;case"reg":return s(r,e);case"command":return g(r,e);case"array":return v(r,e);case"ivar":return y(r,e);case"assign":return d(r,e);case"binary":return f(e.operator,x(e.left,r),x(e.right,r));case"macro":return l(r,e);case"return":return x(e.value,r);case"if":return p(r,e);case"function":return m(r,e);case"prog":return h(r,e);case"call":var t=x(e.func,r);return t.apply(null,e.args.map(function(e){return x(e,r)}));default:o("Unable to evaluate "+e.type)}}}var u=["advancement","ban","blockdata","clear","clone","debug","defaultgamemode","deop","difficulty","effect","enchant","entitydata","execute","fill","function","gamemode","gamerule","give","help","kick","kill","list","locate","me","op","pardon","particle","playsound","publish","recipe","reload","replaceitem","save","say","scoreboard","seed","setblock","setidletimeout","setmaxplayers","setworldspawn","spawnpoint","spreadplayers","stats","stop","stopsound","summon","teleport","tell","tellraw","testfor","testforblock","testforblocks","time","title","toggledownfall","tp","transferserver","trigger","weather","whitelist","worldborder","wsserver","xp"];function a(e){var r=0,t=1,n=0,u=null,a=true;return{next:i,peek:c,eof:l,croak:s,last:o,lastWasNewLine:f};function i(){if(c()=="\n")a=true;else if("\r\t ".indexOf(c())==-1)a=false;u=c();var i=e.charAt(r++);if(i=="\n")t++,n=0;else n++;return i}function o(){return u}function f(){return a}function c(){return e.charAt(r)}function l(){return c()==""}function s(e){var r=e+" at ("+t+":"+n+")";console.error(r);throw new Error(r)}}function i(e){var r=null;var t=" function macro group if elseif else return execute true false var for foreach in ";var n=null;return{next:L,peek:z,eof:S,croak:e.croak,last:F};function u(e){return t.indexOf(" "+e+" ")>=0}function o(e){return/[0-9]/i.test(e)}function c(e){return/[a-z0-9-_\$]/i.test(e)}function l(e){return c(e)}function s(e){return/\$[a-z0-9-_]/i.test(e)}function p(e){return"+-*/%=&|<>!".indexOf(e)>=0}function v(e){return",;(){}[]".indexOf(e)>=0}function y(e){return" \t\n\r".indexOf(e)>=0}function d(r){var t="";while(!e.eof()&&r(e.peek())){t+=e.next()}return t}function g(){var e=false;var r=d(function(r){if(r=="."){if(e)return false;e=true;return true}return o(r)});return{type:"num",value:parseFloat(r)}}function h(){var e=d(l);var r;if(u(e))r="kw";else if(s(e))r="ivar";else r="reg";return{type:r,value:e}}function m(r){var t=false,n="";e.next();while(!e.eof()){var u=e.next();if(t){n+=u;t=false}else if(u=="\\"){t=true}else if(u==r){break}else{n+=u}}return n}function x(r){if(r.indexOf("`")>=0){var t=false,n=[],u="";var o=r.split("");for(var c=0;c<o.length;c++){var l=o[c];if(t){if(l=="`"){t=false;var s=f(i(a(u)));if(s.prog.length!=0){for(var p=0;p<s.prog.length;p++){if(s.prog[p].type=="comment"){e.croak("Comments are not allowed in evaluation blocks")}else if(s.prog[p].type=="function"){e.croak("Functions are not allowed in evaluation blocks")}else if(s.prog[p].type=="macro"){e.croak("Creating macros is not allowed in evaluation blocks")}}n.push(s)}u=""}else{u+=l;if(c==o.length-1){if(u)n.push({type:"str",value:u})}}}else{if(l=="`"){t=true;if(u)n.push({type:"str",value:u});u=""}else{u+=l;if(c==o.length-1){if(u)n.push({type:"str",value:u})}}}}return n}else{return r}}function k(){return{type:"str",value:x(m('"'))}}function b(){var r=e.lastWasNewLine();e.next();if(e.peek()=="!"){if(!r)e.croak('Settings with "@!" need to start at the begining of a line');return O()}else{return w()}}function w(){var e=d(function(e){return!y(e)&&e!=";"});return{type:"selector",value:"@"+e}}function O(){var e=d(function(e){return e!="\n"});return{type:"setting",value:e.replace("\r","")}}function E(){e.next();return{type:"relative"}}function C(){e.next();return{type:"colon"}}function U(){if(!e.lastWasNewLine())e.croak('Comments with "#" need to start at the begining of a line');var r=d(function(e){return e!="\n"});return{type:"comment",value:r}}function j(){d(function(e){return e!="\n"});e.next()}function A(){var r=d(function(e){return e=="/"});if(r=="//"){j()}else{e.next()}}function N(){d(y);if(e.eof())return null;var r=e.peek();if(r=="#"){return U()}if(r=="/"){A();return N()}if(r=="@")return b();if(r=='"')return k();if(r=="~")return E();if(r==":")return C();if(o(r))return g();if(c(r))return h();if(v(r))return{type:"punc",value:e.next()};if(p(r))return{type:"op",value:d(p)};e.croak("Can't handle character: "+r)}function z(){return r||(r=N())}function F(){return n}function L(){n=z();var e=r;r=null;return e||N()}function S(){return z()==null}}var o={type:"bool",value:false};function f(e){var r={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"+":10,"-":10,"*":20,"/":20,"%":20};return $();function t(r){var t=e.peek();return t&&t.type=="punc"&&(!r||t.value==r)&&t}function n(r){var t=e.peek();return t&&t.type=="kw"&&(!r||t.value==r)&&t}function a(r){var t=e.peek();return t&&t.type=="op"&&(!r||t.value==r)&&t}function i(){var r=e.peek();return r&&r.type=="comment"}function f(){var r=e.peek();return r&&r.type=="reg"}function c(r){if(t(r))e.next();else e.croak('Expecting punctuation: "'+r+'"')}function l(r){if(i())z();e.next()}function s(r){if(n(r))e.next();else e.croak('Expecting keyword: "'+r+'"')}function p(r){if(a(r))e.next();else e.croak('Expecting operator: "'+r+'"')}function v(){e.croak("Unexpected token: "+JSON.stringify(e.peek()))}function y(t,n){var u=a();if(u){var i=r[u.value];if(i>n){e.next();return y({type:u.value=="="?"assign":"binary",operator:u.value,left:t,right:y(M(),i)},n)}}return t}function d(r,n,u,a){var i=[],o=true;c(r);while(!e.eof()){if(t(n))break;if(o)o=false;else if(P())c(u);if(t(n))break;i.push(a())}c(n);return i}function g(e){return{type:"call",func:e,args:d("(",")",",",D)}}function h(){var r=e.next();if(r.type!="ivar")e.croak("Expecting variable name");return r.value}function m(){s("if");var r=D();var t=D();var u={type:"if",cond:r,then:t};if(n("else")){e.next();u.else=D()}return u}function x(){s("var");return{type:"var",value:h()}}function k(){s("for");var e=d("(",")",";",D);var r=D();return{type:"for",params:e,then:r}}function b(){s("foreach");c("(");s("var");var e=A();s("in");var r=D();c(")");var t=D();return{type:"foreach",variable:e,param:r,then:t}}function w(){e.next();var r=e.next();if(e.peek().type=="colon"){var n={type:"command",value:[{type:"reg",value:"function"},r]};while(!e.eof()){n.value.push(e.next());if(t(";"))break;else if(e.eof())c(";")}return n}else{return{type:"function",name:r.value,body:D()}}}function O(){e.next();return{type:"group",name:e.next().value,body:D()}}function E(){e.next();return{type:"macro",name:e.next().value,vars:d("(",")",",",h),body:D()}}function C(){e.next();return{type:"return",value:D()}}function U(){e.next();var r={type:"execute",selector:"",pos:[]};var n=0;while(!e.eof()){if(n==5){break}else{var u=D();if(n==0)r.selector=u;else if(n>0&&n<4)r.pos.push(u);else if(n==4)r.prog=u;n++;if(n==4&&!t("{"))v()}}return r}function j(){return{type:"bool",value:e.next().value=="true"}}function A(){var r=e.next();if(t("[")){c("[");while(!e.eof()){if(t("]"))break;if(e.peek().type=="kw")v();r.index=D();if(t("]"))break;else e.croak('Expecting punctuation: "]"')}c("]")}return r}function N(){return{type:"array",value:d("[","]",",",function r(){var t=e.peek();if(t.type=="kw"&&t.value!="false"&&t.value!="true"&&t.value!="macro")v();else return D()})}}function z(){return{type:"comment",value:e.next().value}}function F(){var r=e.next().value.trim();var t=r.indexOf(":");if(t==-1)e.croak('Expecting separator: ":"');return{type:"setting",name:r.substring(r.indexOf("!")+1,t).trim(),value:r.substring(t+1).trim()}}var L;function S(){var r={type:"command",value:[]};if(u.includes(e.peek().value)){r.value.push(e.next());while(!e.eof()){var n=D();r.value.push(n);if(t(";"))break;else if(e.eof())c(";")}return r}else{return e.next()}}function W(e){e=e();return t("(")?g(e):e}function M(){return W(function(){if(t("(")){e.next();var r=D();c(")");return r}if(t("{"))return _();if(t("["))return N();if(n("if"))return m();if(n("var"))return x();if(n("true")||n("false"))return j();if(n("for"))return k();if(n("foreach"))return b();if(n("function"))return w();if(n("group"))return O();if(n("execute"))return U();if(n("macro"))return E();if(n("return"))return C();if(i())return z();if(e.peek().type=="reg")return S();if(e.peek().type=="setting")return F();if(e.peek().type=="ivar")return A();var u=e.next();if(u.type=="colon"||u.type=="relative"||u.type=="selector"||u.type=="num"||u.type=="str")return u;v()})}function P(){return!e.last()||e.last()&&e.last().type!="comment"&&e.last().type!="setting"}function $(){var r=[];while(!e.eof()){r.push(D());if(i()){r.push(z())}else if(!e.eof()&&P())c(";")}return{type:"prog",prog:r}}function _(){var e=d("{","}",";",D);if(e.length==0)return o;if(e.length==1)return e[0];return{type:"prog",prog:e}}function D(){return W(function(){return y(M(),0)})}}var c=f(i(a(r)));var l=n(c);return l};e.help=function e(){console.log(["    mcs","    A simple and easy to use scripting language which compiles into Minecraft functions.","","    Usage:","    var output = mcs(input) - Converts MCS language into an object of function files","","    Check the GitHub repository for more info: https://github.com/PandawanFr/mcs"])};return e}();if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=e}else{if(typeof define==="function"&&define.amd){define([],function(){return e})}else{window.mcs=e}}})();